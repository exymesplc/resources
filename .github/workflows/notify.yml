name: Document Upload Notification

on:
  push:
    paths:
      - 'docs/QSG/**'
      - 'docs/brochures/**'
      - 'docs/images/products/**'
      - 'docs/handbook/**'
      - 'docs/apnote/**'
      - 'docs/SDS/**'
      - 'docs/images/logo/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read

jobs:
  send-notification:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'SILENT')"
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Identify Changed Folders
        id: folders
        run: |
          # Get unique folders under docs/, strip 'docs/', and format as HTML links
          RAW_FOLDERS=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | grep '^docs/' | cut -d/ -f2 | sort -u)
          
          HTML_LINKS=""
          for folder in $RAW_FOLDERS; do
            # This creates: - https://resources.exymesplc.com/folder
            HTML_LINKS+="- <a href='https://resources.exymesplc.com/$folder'>https://resources.exymesplc.com/$folder</a><br>"
          done
          
          echo "list=$HTML_LINKS" >> $GITHUB_OUTPUT

      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true
          audience: api://AzureADTokenExchange

      - name: Acquire Microsoft Graph Token
        id: graph
        run: |
          TOKEN=$(az account get-access-token --resource https://graph.microsoft.com --query accessToken -o tsv)
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Send Email using Microsoft Graph
        env:
          TOKEN: ${{ steps.graph.outputs.token }}
          SENDER: ${{ secrets.MAIL_USERNAME }}
          RECIPIENT: "team@exymesplc.com" 
          HTML_LIST: ${{ steps.folders.outputs.list }}
        run: |
          cat > mail.json <<EOF
          {
            "message": {
              "subject": "Portal Update: New Documents Available",
              "body": { 
                "contentType": "HTML", 
                "content": "Hello,<br><br>New documents or resources have been uploaded to the following sections of the portal:<br><br><strong>$HTML_LIST</strong><br><br>Please visit the links above to view or download the latest versions.<br><br>---<br>Sent by Exymes PLC Automated Notification System" 
              },
              "toRecipients": [
                { "emailAddress": { "address": "$RECIPIENT" } }
              ]
            }
          }
          EOF
          curl -i -X POST \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d @mail.json \
            "https://graph.microsoft.com/v1.0/users/$SENDER/sendMail"
