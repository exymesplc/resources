name: Document Upload Notification

on:
  push:
    paths:
      - 'docs/QSG/**'
      - 'docs/brochures/**'
      - 'docs/images/products/**'
      - 'docs/handbook/**'
      - 'docs/apnote/**'
      - 'docs/SDS/**'
      - 'docs/images/logo/**'

# Essential for OIDC (Secretless) authentication
permissions:
  id-token: write
  contents: read

jobs:
  send-notification:
    runs-on: ubuntu-latest
    # This line prevents the email if the commit message contains the word "SILENT"
    if: "!contains(github.event.head_commit.message, 'SILENT')"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Azure Login via OIDC
        id: login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          # M365 accounts often don't have an Azure Billing Subscription
          allow-no-subscriptions: true
          audience: api://AzureADTokenExchange

      - name: Acquire Microsoft Graph Token
        id: graph
        run: |
          # Request a short-lived token specifically for Microsoft Graph
          TOKEN=$(az account get-access-token \
            --resource https://graph.microsoft.com \
            --query accessToken -o tsv)
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Send Email via Microsoft Graph API
        env:
          TOKEN: ${{ steps.graph.outputs.token }}
          # This pulls 'notifications@exymesplc.com' from your GitHub Secrets
          SENDER: ${{ secrets.MAIL_USERNAME }}
          # Change this to whoever should receive the alerts
          RECIPIENT: "simon@cynapse.co.uk" 
        run: |
          # 1. Create the Email JSON payload
          cat > mail.json <<EOF
          {
            "message": {
              "subject": "Exymes Resources: New Files Available",
              "body": { 
                "contentType": "HTML", 
                "content": "Hi,<br><br>New documents or product images have been uploaded to the portal.<br><br>View the latest updates here:<br><strong>View Folder:</strong> https://github.com/YOUR_ORG/YOUR_REPO/tree/main/docs/QSG/<br><strong>View Change Log:</strong> ${{ github.event.compare }}<br><br><br>This is an automated notification."
              },
              "toRecipients": [
                { "emailAddress": { "address": "$RECIPIENT" } }
              ]
            },
            "saveToSentItems": false
          }
          EOF

          # 2. Call the Graph API to send the mail
          curl -i -X POST \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d @mail.json \
            "https://graph.microsoft.com/v1.0/users/$SENDER/sendMail"
