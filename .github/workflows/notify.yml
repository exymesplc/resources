name: Document Upload Notification

on:
  push:
    paths:
      - 'docs/QSG/**'
      - 'docs/brochures/**'
      - 'docs/images/products/**'
      - 'docs/handbook/**'
      - 'docs/apnote/**'
      - 'docs/SDS/**'
      - 'docs/images/logo/**'

    workflow_dispatch:

concurrency:
  group: messaging
  cancel-in-progress: true

jobs:
  notify-subscribers:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Changed Folders and Fetch Subscribers
        id: prepare_data
        run: |
          # 1. Identify which folders were modified in this push
          CHANGED_PATHS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | cut -d/ -f1 | sort -u)
          
          HTML_LIST="<ul>"
          for folder in $CHANGED_PATHS; do
            case $folder in
              QSG) HTML_LIST="$HTML_LIST<li>Quick Start Guides</li>" ;;
              handbook) HTML_LIST="$HTML_LIST<li>Handbooks</li>" ;;
              apnote) HTML_LIST="$HTML_LIST<li>Application Notes</li>" ;;
              SDS) HTML_LIST="$HTML_LIST<li>Safety Data Sheets</li>" ;;
              brochures) HTML_LIST="$HTML_LIST<li>Brochures</li>" ;;
              images) HTML_LIST="$HTML_LIST<li>Product Media & Assets</li>" ;;
            esac
          done
          HTML_LIST="$HTML_LIST</ul>"
          echo "html_list=$HTML_LIST" >> $GITHUB_OUTPUT

          # 2. Download live CSV from Google Sheets
          curl -L "https://docs.google.com/spreadsheets/d/e/2PACX-1vQhwT-MeZk9CTqjtRv5_e0l36gRsdskoo-gtOftXffwkzFBwPrvt2ysO7fbPT1-dxk6QiLhDmZhyOFW/pub?output=csv" > raw_subs.csv
          
          # 3. Process Emails
          emails=$(tail -n +2 raw_subs.csv | cut -d ',' -f 2 | tr -d '\r' | grep '@' | sort | uniq | tr '\n' ',' | sed 's/,$//')
          tail -n +2 raw_subs.csv | cut -d ',' -f 2 | tr -d '\r' | grep '@' | sort | uniq > subscribers.txt
          
          echo "recipients=$emails" >> $GITHUB_OUTPUT

      - name: Send Notification Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587 # Changed to 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }} # Use the 16-char code here
          
          subject: "Portal Update: New Documents Available"
          # Enabling HTML content
          html_body: |
            <html>
              <body style="font-family: sans-serif; color: #333;">
                <p>Hello,</p>
                <p>New documents or resources have been uploaded to the following sections of the portal:</p>
                <div style="margin: 20px 0;">
                  ${{ steps.prepare_data.outputs.html_list }}
                </div>
                <p>Please visit the <a href="https://resources.exymesplc.com">Exymes Resources Portal</a> to view or download the latest versions.</p>
                <hr>
                <p style="font-size: 11px; color: #777;">Sent by Exymes PLC Automated Notification System</p>
              </body>
            </html>
          
          to: ${{ steps.prepare_data.outputs.recipients }}
          from: Exymes Resources <portal@exymesplc.com>

      - name: Silent Commit Subscriber List
        run: |
          git config --global user.name "Exymes Automation"
          git config --global user.email "bot@exymesplc.com"
          git add subscribers.txt
          git commit -m "Automated sync: Updated subscribers.txt [skip ci]" || echo "No changes to commit"
          git push
