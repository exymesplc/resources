name: Send Portal Update

on:
  push:
    paths:
      - 'docs/QSG/**'
      - 'docs/brochures/**'
      - 'docs/images/products/**'
      - 'docs/handbook/**'
      - 'docs/apnote/**'
      - 'docs/SDS/**'
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Process Data
        id: data
        run: |
          # 1. Detect folders modified inside 'docs/'
          BEFORE=${{ github.event.before }}
          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            PATHS=$(git ls-tree -d --name-only HEAD docs/ | cut -d/ -f2 | sort -u)
          else
            PATHS=$(git diff --name-only $BEFORE ${{ github.sha }} | grep '^docs/' | cut -d/ -f2 | sort -u)
          fi
          
          # 2. Build HTML list with direct links
          BASE_URL="https://resources.exymesplc.com"
          LIST="<ul style='list-style: none; padding: 0;'>"
          
          for folder in $PATHS; do
            case $folder in
              QSG) NAME="Quick Start Guides" ;;
              handbook) NAME="Handbooks" ;;
              apnote) NAME="Application Notes" ;;
              SDS) NAME="Safety Data Sheets" ;;
              brochures) NAME="Brochures" ;;
              images) NAME="Product Media & Assets" ;;
              *) NAME="$folder" ;;
            esac
            LIST="$LIST<li style='margin-bottom: 12px;'>ðŸ“‚ <a href='$BASE_URL/$folder/' style='color: #004a99; font-weight: bold; text-decoration: underline;'>$NAME</a></li>"
          done
          LIST="$LIST</ul>"
          echo "html_list=$LIST" >> $GITHUB_OUTPUT

          # 3. Fetch Subscribers Securely via Secret URL
          curl -L "${{ secrets.SUBSCRIBER_URL }}" > temp_raw.csv
          EMAILS=$(grep -o '[[:alnum:]+\._-]\+@[[:alnum:]+\._-]\+\.[[:alnum:]+\._-]\+' temp_raw.csv | sort | uniq | tr '\n' ',' | sed 's/,$//')
          
          if [ -z "$EMAILS" ]; then
            echo "No recipients found. Ending workflow."
            exit 0
          fi
          
          echo "recipients=$EMAILS" >> $GITHUB_OUTPUT
          rm temp_raw.csv

      - name: Send Email via Brevo
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp-relay.brevo.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "Exymes Resources Update: New Documents Available"
          html_body: |
            <html>
              <head>
                <style>
                  @import url('https://cdn.jsdelivr.net/npm/geist@1.3.0/dist/fonts/geist-sans/style.css');
                  body, p, li, h2, a {
                    font-family: 'Geist Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif !important;
                  }
                </style>
              </head>
              <body style="font-family: 'Geist Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif; line-height: 1.6; color: #111; max-width: 600px; margin: auto; padding: 40px; border: 1px solid #eeeeee; border-top: 4px solid #1D7492;">
                <div style="margin-bottom: 30px;">
                  <img src="https://resources.exymesplc.com/images/logo/Exymes_Logo.png" alt="Exymes Logo" style="height: 32px; width: auto;">
                </div>
                
                <h2 style="color: #1D7492; border-bottom: 1px solid #eee; padding-bottom: 10px; font-weight: 600; font-size: 22px; letter-spacing: -0.02em;">New Portal Updates</h2>
                <p style="font-size: 16px; color: #444;">Hello,</p>
                <p style="font-size: 16px; color: #444;">New resources have been uploaded to the <strong>Exymes Resources Portal</strong>. You can view the new files in the following sections:</p>
                
                <div style="background: #f4f7f9; padding: 20px; border-radius: 10px; margin: 24px 0; border-left: 4px solid #1D7492;">
                  ${{ steps.data.outputs.html_list }}
                </div>
                
                <p style="font-size: 16px; color: #444;">To view the complete library, please visit <a href="https://resources.exymesplc.com" style="color: #1D7492; text-decoration: none; font-weight: 600;">resources.exymesplc.com</a>.</p>
                
                <hr style="border: 0; border-top: 1px solid #eeeeee; margin: 40px 0 20px 0;">
                
                <footer style="font-size: 11px; color: #a1a1a1; text-align: left;">
                  <p>Â© 2026 EXYMES LTD. This is an automated notification based on your portal subscription.</p>
                  <p>
                    <a href="{{ unsubscribe }}" style="color: #a1a1a1; text-decoration: underline;">Unsubscribe from these alerts</a>
                  </p>
                </footer>
              </body>
            </html>
          to: ${{ steps.data.outputs.recipients }}
          from: Exymes Portal <notifications@exymesplc.com>
