name: Send Portal Update

on:
  push:
    paths:
      - 'docs/QSG/**'
      - 'docs/brochures/**'
      - 'docs/images/products/**'
      - 'docs/handbook/**'
      - 'docs/apnote/**'
      - 'docs/SDS/**'
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Process Data
        id: data
        run: |
          # 1. Detect folders modified inside 'docs/'
          BEFORE=${{ github.event.before }}
          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            PATHS=$(git ls-tree -d --name-only HEAD docs/ | cut -d/ -f2 | sort -u)
          else
            PATHS=$(git diff --name-only $BEFORE ${{ github.sha }} | grep '^docs/' | cut -d/ -f2 | sort -u)
          fi
          
          # 2. Build HTML list with direct links
          BASE_URL="https://resources.exymesplc.com"
          LIST="<ul style='list-style: none; padding: 0;'>"
          
          for folder in $PATHS; do
            case $folder in
              QSG) NAME="Quick Start Guides" ;;
              handbook) NAME="Handbooks" ;;
              apnote) NAME="Application Notes" ;;
              SDS) NAME="Safety Data Sheets" ;;
              brochures) NAME="Brochures" ;;
              images) NAME="Product Media & Assets" ;;
              *) NAME="$folder" ;;
            esac
            # We link to the folder on the website (removing 'docs/' from the URL)
            LIST="$LIST<li style='margin-bottom: 12px;'>ðŸ“‚ <a href='$BASE_URL/$folder/' style='color: #004a99; font-weight: bold; text-decoration: underline;'>$NAME</a></li>"
          done
          LIST="$LIST</ul>"
          echo "html_list=$LIST" >> $GITHUB_OUTPUT

          # 3. Fetch Subscribers from Google Sheet
          curl -L "https://docs.google.com/spreadsheets/d/e/2PACX-1vQhwT-MeZk9CTqjtRv5_e0l36gRsdskoo-gtOftXffwkzFBwPrvt2ysO7fbPT1-dxk6QiLhDmZhyOFW/pub?output=csv" > raw.csv
          EMAILS=$(grep -o '[[:alnum:]+\._-]\+@[[:alnum:]+\._-]\+\.[[:alnum:]+\._-]\+' raw.csv | sort | uniq | tr '\n' ',' | sed 's/,$//')
          grep -o '[[:alnum:]+\._-]\+@[[:alnum:]+\._-]\+\.[[:alnum:]+\._-]\+' raw.csv | sort | uniq > subscribers.txt
          echo "recipients=$EMAILS" >> $GITHUB_OUTPUT

       - name: Send Email via Brevo
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp-relay.brevo.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "Exymes Resources Update: New Documents Available"
          html_body: |
            <html>
              <head>
                <style>
                  /* Import Geist Sans */
                  @import url('https://cdn.jsdelivr.net/npm/geist@1.3.0/dist/fonts/geist-sans/style.css');
                  
                  body, p, li, h2, a {
                    font-family: 'Geist Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif !important;
                  }
                </style>
              </head>
              <body style="font-family: 'Geist Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: auto; padding: 20px; border: 1px solid #eeeeee; border-top: 4px solid #004a99;">
                <div style="text-align: center; margin-bottom: 25px;">
                  <img src="https://resources.exymesplc.com/images/logo/Exymes_Logo.png" alt="Exymes Ltd" style="max-width: 180px; height: auto;">
                </div>
                
                <h2 style="color: #004a99; border-bottom: 1px solid #eee; padding-bottom: 10px; font-weight: 600;">New Portal Updates</h2>
                <p>Hello,</p>
                <p>New resources have been uploaded to the <strong>Exymes Resources Portal</strong>. You can view the new files in the following sections:</p>
                
                <div style="background: #f4f7f9; padding: 20px; border-radius: 10px; margin: 20px 0;">
                  ${{ steps.data.outputs.html_list }}
                </div>
                
                <p>To view the complete library, please visit <a href="https://resources.exymesplc.com" style="color: #004a99; text-decoration: none; font-weight: 600;">resources.exymesplc.com</a>.</p>
                
                <hr style="border: 0; border-top: 1px solid #eeeeee; margin: 40px 0 20px 0;">
                
                <footer style="font-size: 11px; color: #999999; text-align: center;">
                  <p>Â© 2026 Exymes Ltd. This is an automated notification that you have subscribed to.</p>
                  <p>
                    <a href="mailto:notifications@exymesplc.com?subject=Unsubscribe Request" style="color: #999999; text-decoration: underline;">Unsubscribe from these alerts</a>
                  </p>
                </footer>
              </body>
            </html>
          to: ${{ steps.data.outputs.recipients }}
          from: Exymes Resources <notifications@exymesplc.com>
      - name: Silent Sync
        run: |
          git config --global user.name "Exymes Bot"
          git config --global user.email "bot@exymesplc.com"
          git add subscribers.txt
          git commit -m "Sync subscribers [skip ci]" || true
          git push || true
