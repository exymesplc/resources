name: Document Upload Notification

on:
  push:
    paths:
      - 'docs/QSG/**'
      - 'docs/brochures/**'
      - 'docs/images/products/**'
      - 'docs/handbook/**'
      - 'docs/apnote/**'
      - 'docs/SDS/**'
      - 'docs/images/logo/**'
  workflow_dispatch:

concurrency:
  group: messaging
  cancel-in-progress: true

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Process Data
        id: data
        run: |
          # 1. Detect Changes
          BEFORE=${{ github.event.before }}
          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            PATHS=$(git ls-tree -d --name-only HEAD docs/ | cut -d/ -f1 | sort -u)
          else
            PATHS=$(git diff --name-only $BEFORE ${{ github.sha }} | grep '^docs/' | cut -d/ -f2 | sort -u)
          fi
          
          LIST="<ul>"
          for folder in $PATHS; do
            case $folder in
              QSG) LIST="$LIST<li>Quick Start Guides</li>" ;;
              handbook) LIST="$LIST<li>Handbooks</li>" ;;
              apnote) LIST="$LIST<li>Application Notes</li>" ;;
              SDS) LIST="$LIST<li>Safety Data Sheets</li>" ;;
              brochures) LIST="$LIST<li>Brochures</li>" ;;
              images) LIST="$LIST<li>Product Media & Assets</li>" ;;
            esac
          done
          LIST="$LIST</ul>"
          echo "html_list=$LIST" >> $GITHUB_OUTPUT

          # 2. Get Subscribers (The most likely culprit)
          # We download the CSV and try to find the email column automatically
          curl -L "https://docs.google.com/spreadsheets/d/e/2PACX-1vQhwT-MeZk9CTqjtRv5_e0l36gRsdskoo-gtOftXffwkzFBwPrvt2ysO7fbPT1-dxk6QiLhDmZhyOFW/pub?output=csv" > raw.csv
          
          # This command looks for anything with an '@' symbol in the file
          EMAILS=$(grep -o '[[:alnum:]+\._-]\+@[[:alnum:]+\._-]\+\.[[:alnum:]+\._-]\+' raw.csv | sort | uniq | tr '\n' ',' | sed 's/,$//')
          
          if [ -z "$EMAILS" ]; then
            echo "ERROR: No email addresses found in the Google Sheet CSV!"
            exit 1
          fi
          
          echo "recipients=$EMAILS" >> $GITHUB_OUTPUT
          echo "Found these subscribers: $EMAILS"
      - name: Send Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp-relay.brevo.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "Portal Update: New Documents Available"
          html_body: |
            <html>
              <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
                <p>Hello,</p>
                <p>New resources have been uploaded to the following sections of the portal:</p>
                ${{ steps.data.outputs.html_list }}
                <p>Visit the portal here: <a href="https://resources.exymesplc.com">resources.exymesplc.com</a></p>
                <hr>
                <footer style="font-size: 12px; color: #888;">Exymes PLC Automated Notification System</footer>
              </body>
            </html>
          to: ${{ steps.data.outputs.recipients }}
          from: Exymes Resources <swickes@exymesplc.com>

      - name: Silent Sync
        run: |
          git config --global user.name "Exymes Bot"
          git config --global user.email "bot@exymesplc.com"
          git add subscribers.txt
          git commit -m "Sync subscribers [skip ci]" || exit 0
          git push
